name: FINAL CI/CD

on:
  # ✅ PR 阶段：只运行 CI；Merge 后 push 到 main：运行 CI + CD
  workflow_dispatch:  # 支持手动触发
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]  # PR 打开、更新、重新打开时运行 CI
  push:
    branches: [ main ]  # PR 合并后触发，运行 CI + CD

jobs:
  # ==================== CI 阶段 ====================

  backend-ci:
    name: Backend CI
    uses: ./.github/workflows/backend.yml
    secrets: inherit

  frontend-ci:
    name: Frontend CI
    uses: ./.github/workflows/frontend.yml
    secrets: inherit

  python-ci:
    name: Python Services CI
    uses: ./.github/workflows/python-services.yml
    secrets: inherit

  # 阶段 4: CI 总结
  ci-summary:
    name: CI 阶段总结
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci, python-ci]
    if: always()
    outputs:
      ci_status: ${{ steps.check.outputs.status }}
    steps:
      - name: 检查 CI 状态
        id: check
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " CI 阶段总结报告"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Backend CI:        ${{ needs.backend-ci.result }}"
          echo "Frontend CI:       ${{ needs.frontend-ci.result }} (允许失败)"
          echo "Python Services:   ${{ needs.python-ci.result }}"
          echo ""

          # 前端 CI 失败不阻止部署，只检查 backend 和 python
          if [[ "${{ needs.backend-ci.result }}" == "failure" ]] || \
             [[ "${{ needs.python-ci.result }}" == "failure" ]]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo " ❌ CI 失败！流程终止"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo " ✅ CI 核心检查通过！"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "status=success" >> $GITHUB_OUTPUT
          fi

  # ==================== CD 阶段 ====================
  # ✅ 修改2：CD 阶段仅在推送到 main 分支且 CI 成功时触发

  deploy-staging:
    name: 部署到测试环境
    runs-on: ubuntu-latest
    needs: ci-summary
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.ci-summary.outputs.ci_status == 'success'  # ✅ 修改2：PR合并后会触发push事件
    environment:
      name: staging
      url: http://1.94.200.25:8080
    
    steps:
      - name: 配置 SSH 密钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: 部署到测试服务器
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " 部署到测试环境 (CI通过 + PR已合并)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            'bash /root/voyagemate/new-voyage-mate/scripts/deploy-full.sh'

  smoke-test:
    name: 冒烟测试
    runs-on: ubuntu-latest
    needs: deploy-staging
    # 依赖 deploy-staging，它已经检查了条件，所以这里不需要重复检查
    steps:
      - name: 执行冒烟测试
        run: |
          echo "执行冒烟测试..."

  approval-gate:
    name: 等待人工审批
    runs-on: ubuntu-latest
    needs: smoke-test
    # 依赖 smoke-test，条件已传递
    steps:
      - name: 等待审批
        run: echo "等待管理员审批..."

  deploy-production:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    needs: approval-gate
    # 依赖 approval-gate，条件已传递
    steps:
      - name: 部署
        run: echo "生产环境部署完成 ✅"
