name: FINAL CI/CD

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  # ==================== CI é˜¶æ®µ ====================
  
  # é˜¶æ®µ 1: Backend CI
  backend-ci:
    name:  Backend CI
    uses: ./.github/workflows/backend.yml
    secrets: inherit
  
  # é˜¶æ®µ 2: Frontend CI  
  frontend-ci:
    name:  Frontend CI
    uses: ./.github/workflows/frontend.yml
    secrets: inherit
  
  # é˜¶æ®µ 3: Python Services CI
  python-ci:
    name:  Python Services CI
    uses: ./.github/workflows/python-services.yml
    secrets: inherit
  
  # é˜¶æ®µ 4: CI æ€»ç»“ï¼ˆå†³å®šæ˜¯å¦ç»§ç»­ï¼‰
  ci-summary:
    name:  CI é˜¶æ®µæ€»ç»“
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci, python-ci]
    if: always()
    
    outputs:
      ci_status: ${{ steps.check.outputs.status }}
    
    steps:
    - name: æ£€æŸ¥ CI çŠ¶æ€
      id: check
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " CI é˜¶æ®µæ€»ç»“æŠ¥å‘Š"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Backend CI:        ${{ needs.backend-ci.result }}"
        echo "Frontend CI:       ${{ needs.frontend-ci.result }}"
        echo "Python Services:   ${{ needs.python-ci.result }}"
        echo ""
        
        if [[ "${{ needs.backend-ci.result }}" == "failure" ]] || \
           [[ "${{ needs.frontend-ci.result }}" == "failure" ]] || \
           [[ "${{ needs.python-ci.result }}" == "failure" ]]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " CI å¤±è´¥ï¼æµç¨‹ç»ˆæ­¢"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo " CD é˜¶æ®µå°†ä¸ä¼šæ‰§è¡Œ"
          echo " è¯·ä¿®å¤å¤±è´¥çš„æ£€æŸ¥é¡¹åé‡æ–°æäº¤"
          echo ""
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " CI å…¨éƒ¨é€šè¿‡ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo " è¿™æ˜¯ Pull Request"
            echo " CD é˜¶æ®µå°†è¢«è·³è¿‡ï¼ˆä»…åœ¨åˆå¹¶åˆ° main åæ‰§è¡Œï¼‰"
          else
            echo " è¿™æ˜¯æ¨é€åˆ° ${{ github.ref }}"
            echo " å‡†å¤‡è¿›å…¥ CD é˜¶æ®µ"
          fi
          echo ""
          echo "status=success" >> $GITHUB_OUTPUT
        fi

  # ==================== CD é˜¶æ®µ ====================
  # æ³¨æ„ï¼šåªæœ‰åœ¨æ¨é€åˆ° main åˆ†æ”¯ä¸” CI é€šè¿‡æ—¶æ‰æ‰§è¡Œ

  # é˜¶æ®µ 5: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name:  éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: ci-summary
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.ci-summary.result == 'success'
    environment:
      name: staging
      url: http://1.94.200.25:8080  # Backend æµ‹è¯•ç¯å¢ƒ
    
    steps:
    - name: é…ç½® SSH å¯†é’¥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo " ç›®æ ‡æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
        echo " æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
        echo ""
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          'bash /root/voyagemate/new-voyage-mate/scripts/deploy-full.sh'
        
        echo ""
        echo " æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo " è®¿é—®åœ°å€:"
        echo "   Frontend:   http://${{ secrets.SERVER_HOST }}:3000"
        echo "   Backend:    http://${{ secrets.SERVER_HOST }}:8080"
        echo "   Embedding:  http://${{ secrets.SERVER_HOST }}:8000"
        echo "   RAG:        http://${{ secrets.SERVER_HOST }}:8001"

  # é˜¶æ®µ 7: å†’çƒŸæµ‹è¯•
  smoke-test:
    name:  å†’çƒŸæµ‹è¯•
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.deploy-staging.result == 'success'
    
    steps:
    - name: æ‰§è¡Œå†’çƒŸæµ‹è¯•
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " å†’çƒŸæµ‹è¯•"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        echo " ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æµ‹è¯• Backend
        echo " æµ‹è¯• Backend..."
        BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8080/api/actuator/health || echo "000")
        if [ "$BACKEND_STATUS" = "200" ]; then
          echo " Backend å¥åº·æ£€æŸ¥é€šè¿‡ (HTTP 200)"
        else
          echo " Backend å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $BACKEND_STATUS)"
          exit 1
        fi
        
        # æµ‹è¯• Embedding Service
        echo " æµ‹è¯• Embedding Service..."
        EMBEDDING_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8000/health || echo "000")
        if [ "$EMBEDDING_STATUS" = "200" ]; then
          echo " Embedding Service æ­£å¸¸ (HTTP 200)"
        else
          echo "  Embedding Service å¼‚å¸¸ (HTTP $EMBEDDING_STATUS)"
        fi
        
        # æµ‹è¯• RAG Service
        echo " æµ‹è¯• RAG Service..."
        RAG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8001/health || echo "000")
        if [ "$RAG_STATUS" = "200" ]; then
          echo " RAG Service æ­£å¸¸ (HTTP 200)"
        else
          echo " RAG Service å¼‚å¸¸ (HTTP $RAG_STATUS)"
        fi
        
        # æµ‹è¯• Frontend
        echo " æµ‹è¯• Frontend..."
        FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:3000 || echo "000")
        if [ "$FRONTEND_STATUS" = "200" ]; then
          echo " Frontend è®¿é—®æ­£å¸¸ (HTTP 200)"
        else
          echo " Frontend è®¿é—®å¼‚å¸¸ (HTTP $FRONTEND_STATUS)"
        fi
        
        echo ""
        echo " æ‰€æœ‰å†’çƒŸæµ‹è¯•é€šè¿‡"

  # é˜¶æ®µ 8: ç­‰å¾…äººå·¥å®¡æ‰¹ï¼ˆå¯é€‰ï¼‰
  # æ³¨æ„ï¼šè¿™ä¸ªæ­¥éª¤éœ€è¦åœ¨ GitHub ä»“åº“ä¸­é…ç½® Environment
  # è®¾ç½®æ–¹æ³•ï¼šSettings â†’ Environments â†’ New environment â†’ æ·»åŠ  "production-approval"
  approval-gate:
    name:  ç­‰å¾…äººå·¥å®¡æ‰¹
    runs-on: ubuntu-latest
    needs: smoke-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.smoke-test.result == 'success'
    # å¦‚æœä¸éœ€è¦äººå·¥å®¡æ‰¹ï¼Œå¯ä»¥æ³¨é‡Šæ‰ä¸‹é¢çš„ environment é…ç½®
    # environment:
    #   name: production-approval
    
    steps:
    - name: ç­‰å¾…å®¡æ‰¹
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " ç­‰å¾…äººå·¥å®¡æ‰¹"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo " ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        echo " å·²å‘é€å®¡æ‰¹é€šçŸ¥"

  # é˜¶æ®µ 9: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name:  éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: approval-gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.approval-gate.result == 'success'
    environment:
      name: production
      url: http://1.94.200.25:8080  # ç”Ÿäº§ç¯å¢ƒ
    
    steps:
    - name: é…ç½® SSH å¯†é’¥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo " ç›®æ ‡æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
        echo " æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
        echo ""
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          'bash /root/voyagemate/new-voyage-mate/scripts/deploy-full.sh'
        
        echo ""
        echo " ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "ğŸŒ è®¿é—®åœ°å€:"
        echo "   Frontend:   http://${{ secrets.SERVER_HOST }}:3000"
        echo "   Backend:    http://${{ secrets.SERVER_HOST }}:8080"
        echo "   Embedding:  http://${{ secrets.SERVER_HOST }}:8000"
        echo "   RAG:        http://${{ secrets.SERVER_HOST }}:8001"

  # é˜¶æ®µ 10: éƒ¨ç½²åéªŒè¯
  post-deployment:
    name:  éƒ¨ç½²åéªŒè¯
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.deploy-production.result == 'success'
    
    steps:
    - name: å¥åº·æ£€æŸ¥å’ŒéªŒè¯
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " éƒ¨ç½²åéªŒè¯"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # ç­‰å¾…æœåŠ¡ç¨³å®š
        sleep 10
        
        # ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
        echo " ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥..."
        HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8080/api/actuator/health || echo "000")
        
        if [ "$HEALTH_STATUS" = "200" ]; then
          echo " ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ­£å¸¸"
          echo ""
          echo " éƒ¨ç½²ä¿¡æ¯:"
          echo "   æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "   Frontend:   http://${{ secrets.SERVER_HOST }}:3000"
          echo "   Backend:    http://${{ secrets.SERVER_HOST }}:8080"
          echo "   Embedding:  http://${{ secrets.SERVER_HOST }}:8000"
          echo "   RAG:        http://${{ secrets.SERVER_HOST }}:8001"
          echo "   éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo " CI/CD æµç¨‹å®Œæˆï¼"
        else
          echo " ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $HEALTH_STATUS)"
          exit 1
        fi

  # æµç¨‹å®Œæˆæ€»ç»“
  pipeline-complete:
    name:  æµç¨‹å®Œæˆ
    runs-on: ubuntu-latest
    needs: [ci-summary, post-deployment]
    if: always()
    
    steps:
    - name: ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " CI/CD æµç¨‹æ‰§è¡ŒæŠ¥å‘Š"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo " CI é˜¶æ®µ:"
        echo "   çŠ¶æ€: ${{ needs.ci-summary.result }}"
        echo ""
        
        if [[ "${{ needs.post-deployment.result }}" != "skipped" ]]; then
          echo " CD é˜¶æ®µ:"
          echo "   çŠ¶æ€: ${{ needs.post-deployment.result }}"
        else
          echo " CD é˜¶æ®µ:"
          echo "   çŠ¶æ€: è·³è¿‡ï¼ˆPR æˆ– CI å¤±è´¥ï¼‰"
        fi
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        if [[ "${{ needs.ci-summary.result }}" == "success" ]]; then
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo " PR æ£€æŸ¥é€šè¿‡ï¼å¯ä»¥åˆå¹¶"
          elif [[ "${{ needs.post-deployment.result }}" == "success" ]]; then
            echo " å®Œæ•´çš„ CI/CD æµç¨‹æ‰§è¡ŒæˆåŠŸï¼"
          else
            echo " CI é€šè¿‡ï¼Œä½† CD é˜¶æ®µæœ‰é—®é¢˜"
          fi
        else
          echo " CI/CD æµç¨‹å­˜åœ¨å¤±è´¥ç¯èŠ‚"
          exit 1
        fi
