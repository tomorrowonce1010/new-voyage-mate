name: å®Œæ•´ CI/CD æ¼”ç¤ºæµç¨‹

# è§¦å‘æ¡ä»¶ï¼šPR æäº¤åˆ° main æˆ– develop åˆ†æ”¯
on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

# ç¯å¢ƒå˜é‡
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==================== CI é˜¶æ®µ ====================
  
  # é˜¶æ®µ 1ï¼šä»£ç æ£€æŸ¥
  code-check:
    name: ğŸ“ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ  prettier, eslint ç­‰æ£€æŸ¥
        
    - name: å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ‰«æ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®‰å…¨æ‰«æå·¥å…·

  # é˜¶æ®µ 2ï¼šæ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-check  # ä¾èµ–ä»£ç æ£€æŸ¥é€šè¿‡
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
    
    # Backend æ„å»º
    - name: ğŸ”§ æ„å»º Backend
      if: matrix.component == 'backend'
      run: |
        echo "ğŸ“¦ å¼€å§‹æ„å»º Backend..."
        cd backend
        
        # è®¾ç½® Java
        echo "â˜• è®¾ç½® Java 17..."
        
        # æ„å»º
        echo "ğŸ”¨ æ‰§è¡Œ Maven æ„å»º..."
        mvn clean package -DskipTests
        
        # è¿è¡Œæµ‹è¯•
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        mvn test
        
        # å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨é€€å‡ºï¼ˆå› ä¸ºæ²¡æœ‰ continue-on-errorï¼‰
        echo "âœ… Backend æ„å»ºå’Œæµ‹è¯•å®Œæˆ"
    
    # Frontend æ„å»º
    - name: ğŸ”§ æ„å»º Frontend  
      if: matrix.component == 'frontend'
      run: |
        echo "ğŸ“¦ å¼€å§‹æ„å»º Frontend..."
        cd frontend
        
        # è®¾ç½® Node.js
        echo "ğŸ“¦ å®‰è£… Node.js ä¾èµ–..."
        npm ci
        
        # Lint æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œ ESLint æ£€æŸ¥..."
        npm run lint --if-present || echo "è·³è¿‡ lint"
        
        # è¿è¡Œæµ‹è¯•
        echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
        CI=true npm test --if-present || echo "è·³è¿‡æµ‹è¯•"
        
        # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        echo "ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
        CI=false npm run build
        
        echo "âœ… Frontend æ„å»ºå’Œæµ‹è¯•å®Œæˆ"
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.component }}-build
        path: |
          ${{ matrix.component == 'backend' && 'backend/target/*.jar' || 'frontend/build' }}
        retention-days: 7

  # é˜¶æ®µ 3ï¼šé›†æˆæµ‹è¯•
  integration-test:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-and-test  # ä¾èµ–æ„å»ºæµ‹è¯•é€šè¿‡
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        echo "ğŸ”— å¼€å§‹é›†æˆæµ‹è¯•..."
        echo "ğŸ“‹ æµ‹è¯•å„æœåŠ¡ä¹‹é—´çš„æ¥å£å¯¹æ¥..."
        echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"

  # é˜¶æ®µ 4ï¼šCI æ€»ç»“ï¼ˆå†³å®šæ˜¯å¦ç»§ç»­ï¼‰
  ci-summary:
    name: âœ… CI é˜¶æ®µæ€»ç»“
    runs-on: ubuntu-latest
    needs: [code-check, build-and-test, integration-test]
    if: always()
    
    outputs:
      ci_status: ${{ steps.check.outputs.status }}
    
    steps:
    - name: æ£€æŸ¥ CI çŠ¶æ€
      id: check
      run: |
        echo "ğŸ“Š æ£€æŸ¥ CI å„é˜¶æ®µçŠ¶æ€..."
        echo "ä»£ç æ£€æŸ¥: ${{ needs.code-check.result }}"
        echo "æ„å»ºæµ‹è¯•: ${{ needs.build-and-test.result }}"
        echo "é›†æˆæµ‹è¯•: ${{ needs.integration-test.result }}"
        
        if [[ "${{ needs.code-check.result }}" == "failure" ]] || \
           [[ "${{ needs.build-and-test.result }}" == "failure" ]] || \
           [[ "${{ needs.integration-test.result }}" == "failure" ]]; then
          echo "âŒ CI å¤±è´¥ï¼æµç¨‹ç»ˆæ­¢ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âœ… CI å…¨éƒ¨é€šè¿‡ï¼å‡†å¤‡è¿›å…¥ CD é˜¶æ®µ"
          echo "status=success" >> $GITHUB_OUTPUT
        fi

  # ==================== CD é˜¶æ®µ ====================
  # æ³¨æ„ï¼šåªæœ‰åœ¨ main åˆ†æ”¯ä¸” CI é€šè¿‡æ—¶æ‰æ‰§è¡Œ
  
  # é˜¶æ®µ 5ï¼šæ„å»º Docker é•œåƒï¼ˆå‡†å¤‡éƒ¨ç½²ï¼‰
  build-docker:
    name: ğŸ³ æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: ci-summary
    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œï¼ˆä¸åœ¨ PR æ—¶æ‰§è¡Œï¼‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: æ„å»º Docker é•œåƒ
      run: |
        echo "ğŸ³ å¼€å§‹æ„å»º Docker é•œåƒ..."
        echo "ğŸ“¦ Backend é•œåƒ: voyagemate-backend:latest"
        echo "ğŸ“¦ Frontend é•œåƒ: voyagemate-frontend:latest"
        echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"
        
        # å®é™…å‘½ä»¤ç¤ºä¾‹ï¼ˆéœ€è¦ Dockerfileï¼‰ï¼š
        # docker build -t voyagemate-backend:latest ./backend
        # docker build -t voyagemate-frontend:latest ./frontend

  # é˜¶æ®µ 6ï¼šéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build-docker
    environment:
      name: staging
      url: https://staging.voyagemate.com
    
    steps:
    - name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
        echo "ğŸ“ ç›®æ ‡æœåŠ¡å™¨: staging.voyagemate.com"
        echo "ğŸ”„ æ›´æ–°æœåŠ¡..."
        
        # å®é™…éƒ¨ç½²å‘½ä»¤ç¤ºä¾‹ï¼š
        # ssh user@staging-server "docker pull voyagemate-backend:latest"
        # ssh user@staging-server "docker-compose up -d"
        
        echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "ğŸŒ è®¿é—®åœ°å€: https://staging.voyagemate.com"

  # é˜¶æ®µ 7ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒï¼‰
  smoke-test:
    name: ğŸ’¨ å†’çƒŸæµ‹è¯•
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - name: æ‰§è¡Œå†’çƒŸæµ‹è¯•
      run: |
        echo "ğŸ’¨ æ‰§è¡Œå†’çƒŸæµ‹è¯•..."
        echo "âœ… æµ‹è¯•ç¯å¢ƒè¿è¡Œæ­£å¸¸"
        
        # å®é™…æµ‹è¯•å‘½ä»¤ç¤ºä¾‹ï¼š
        # curl -f https://staging.voyagemate.com/health || exit 1

  # é˜¶æ®µ 8ï¼šç­‰å¾…äººå·¥å®¡æ‰¹ï¼ˆå¯é€‰ï¼‰
  approval-gate:
    name: ğŸ‘¤ ç­‰å¾…äººå·¥å®¡æ‰¹
    runs-on: ubuntu-latest
    needs: smoke-test
    environment:
      name: production-approval
    
    steps:
    - name: ç­‰å¾…å®¡æ‰¹
      run: |
        echo "â³ ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        echo "ğŸ“§ å·²å‘é€å®¡æ‰¹é€šçŸ¥"

  # é˜¶æ®µ 9ï¼šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸ¯ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: approval-gate
    environment:
      name: production
      url: https://voyagemate.com
    
    steps:
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      run: |
        echo "ğŸ¯ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        echo "ğŸ“ ç›®æ ‡æœåŠ¡å™¨: voyagemate.com"
        echo "ğŸ”„ æ»šåŠ¨æ›´æ–°æœåŠ¡..."
        
        # å®é™…éƒ¨ç½²å‘½ä»¤ç¤ºä¾‹ï¼š
        # ssh user@prod-server "docker pull voyagemate-backend:latest"
        # ssh user@prod-server "docker-compose up -d --no-deps --build backend"
        
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "ğŸŒ è®¿é—®åœ°å€: https://voyagemate.com"

  # é˜¶æ®µ 10ï¼šéƒ¨ç½²åéªŒè¯
  post-deployment:
    name: âœ… éƒ¨ç½²åéªŒè¯
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
    - name: å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        echo "âœ… æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
        
    - name: é€šçŸ¥éƒ¨ç½²æˆåŠŸ
      run: |
        echo "ğŸ“§ å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥..."
        echo "âœ… CI/CD æµç¨‹å®Œæˆï¼"

  # ==================== æµç¨‹æ€»ç»“ ====================
  
  pipeline-complete:
    name: ğŸ‰ æµç¨‹å®Œæˆ
    runs-on: ubuntu-latest
    needs: [ci-summary, post-deployment]
    if: always()
    
    steps:
    - name: ç”ŸæˆæŠ¥å‘Š
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ CI/CD æµç¨‹æ‰§è¡ŒæŠ¥å‘Š"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "CI é˜¶æ®µ:"
        echo "  âœ… ä»£ç æ£€æŸ¥: ${{ needs.ci-summary.result }}"
        echo ""
        echo "CD é˜¶æ®µ:"
        echo "  âœ… éƒ¨ç½²éªŒè¯: ${{ needs.post-deployment.result }}"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [[ "${{ needs.ci-summary.result }}" == "success" ]] && \
           [[ "${{ needs.post-deployment.result }}" == "success" ]]; then
          echo "ğŸ‰ å®Œæ•´çš„ CI/CD æµç¨‹æ‰§è¡ŒæˆåŠŸï¼"
        else
          echo "âŒ CI/CD æµç¨‹å­˜åœ¨å¤±è´¥ç¯èŠ‚"
          exit 1
        fi

