# ğŸ¬ CI/CD æµç¨‹å®é™…æ¼”ç¤ºæ­¥éª¤

## ğŸ“Œ å‰ææ¡ä»¶

- âœ… å·²åˆ›å»ºå®Œæ•´çš„ CI/CD workflow (`pr-cicd-demo.yml`)
- âœ… å·²æäº¤åˆ° main åˆ†æ”¯
- âœ… GitHub Actions å·²å¯ç”¨

---

## ğŸ¯ æ¼”ç¤º 1: CI å¤±è´¥ï¼Œè‡ªåŠ¨é€€å›

### æ­¥éª¤ 1: æ¨é€æ¼”ç¤ºåˆ†æ”¯

```bash
# å½“å‰åˆ†æ”¯: demo/ci-failure
git push origin demo/ci-failure
```

### æ­¥éª¤ 2: åœ¨ GitHub åˆ›å»º Pull Request

1. è®¿é—®ä½ çš„ GitHub ä»“åº“
2. ç‚¹å‡» "Pull requests" â†’ "New pull request"
3. é€‰æ‹© `demo/ci-failure` â†’ `main`
4. æ ‡é¢˜: "Demo: CI Failure Rollback"
5. ç‚¹å‡» "Create pull request"

### æ­¥éª¤ 3: è§‚å¯Ÿ CI æµç¨‹æ‰§è¡Œ

åœ¨ PR é¡µé¢ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
âœ… é˜¶æ®µ 1: ğŸ“ ä»£ç è´¨é‡æ£€æŸ¥ - é€šè¿‡
âœ… é˜¶æ®µ 2: ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• - é€šè¿‡  
âœ… é˜¶æ®µ 3: ğŸ”— é›†æˆæµ‹è¯• - é€šè¿‡
âœ… é˜¶æ®µ 4: âœ… CI é˜¶æ®µæ€»ç»“ - é€šè¿‡

â¹ï¸ CD é˜¶æ®µä¸ä¼šæ‰§è¡Œï¼ˆå› ä¸ºè¿™æ˜¯ PRï¼Œä¸æ˜¯ push to mainï¼‰
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… CI æ‰€æœ‰é˜¶æ®µé€šè¿‡ï¼ˆå› ä¸ºæˆ‘ä»¬åªæ·»åŠ äº†æ–‡æ¡£ï¼‰
- â„¹ï¸ æ˜¾ç¤ºæ¶ˆæ¯ï¼š"CI å…¨éƒ¨é€šè¿‡"
- â¹ï¸ CD é˜¶æ®µè¢«è·³è¿‡ï¼ˆæ˜¾ç¤º "Skipped"ï¼‰

---

## ğŸ¯ æ¼”ç¤º 2: å®é™…çš„ CI å¤±è´¥åœºæ™¯

### åˆ›å»ºä¸€ä¸ªçœŸå®çš„å¤±è´¥

è®©æˆ‘ä»¬åœ¨ Backend ä¸­æ•…æ„å¼•å…¥é”™è¯¯ï¼š

```bash
# 1. åˆ›å»ºæ–°åˆ†æ”¯
git checkout -b demo/real-failure

# 2. åœ¨ Backend ä»£ç ä¸­å¼•å…¥ç¼–è¯‘é”™è¯¯
cat >> backend/src/main/java/com/se_07/backend/BrokenTest.java << 'EOF'
package com.se_07.backend;

public class BrokenTest {
    // æ•…æ„çš„è¯­æ³•é”™è¯¯ï¼šç¼ºå°‘åˆ†å·
    public void test() {
        String x = "broken"
    }
}
EOF

# 3. æäº¤å¹¶æ¨é€
git add backend/src/main/java/com/se_07/backend/BrokenTest.java
git commit -m "test: intentional compilation error"
git push origin demo/real-failure

# 4. åˆ›å»º PR
```

### è§‚å¯Ÿå¤±è´¥æµç¨‹

åœ¨ GitHub Actions ä¸­ä½ ä¼šçœ‹åˆ°ï¼š

```
âœ… é˜¶æ®µ 1: ğŸ“ ä»£ç è´¨é‡æ£€æŸ¥ - é€šè¿‡
âŒ é˜¶æ®µ 2: ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• - å¤±è´¥
   â””â”€ Backend ç¼–è¯‘é”™è¯¯ï¼š';' expected
â¹ï¸ é˜¶æ®µ 3: ğŸ”— é›†æˆæµ‹è¯• - è·³è¿‡
âŒ é˜¶æ®µ 4: âœ… CI é˜¶æ®µæ€»ç»“ - å¤±è´¥
   â””â”€ âŒ CI å¤±è´¥ï¼æµç¨‹ç»ˆæ­¢ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”™ CD é˜¶æ®µå®Œå…¨ä¸ä¼šæ‰§è¡Œï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**å…³é”®ç‚¹**ï¼š
- âŒ æ„å»ºå¤±è´¥åï¼Œåç»­é˜¶æ®µè¢«è·³è¿‡
- âŒ CI æ€»ç»“æ£€æµ‹åˆ°å¤±è´¥ï¼Œè¿”å› exit 1
- ğŸ”™ **CD é˜¶æ®µå› ä¸ºä¾èµ– ci-summary é€šè¿‡ï¼Œæ‰€ä»¥å®Œå…¨ä¸æ‰§è¡Œ**
- ğŸ’¡ PR æ˜¾ç¤ºçº¢è‰² âœ—ï¼Œæ— æ³•åˆå¹¶

### ä¿®å¤å¹¶é‡æ–°æäº¤

```bash
# 1. åˆ é™¤é”™è¯¯çš„æ–‡ä»¶
rm backend/src/main/java/com/se_07/backend/BrokenTest.java

# 2. æäº¤ä¿®å¤
git add backend/src/main/java/com/se_07/backend/BrokenTest.java
git commit -m "fix: remove broken test file"
git push origin demo/real-failure

# 3. GitHub Actions è‡ªåŠ¨é‡æ–°è¿è¡Œ
# 4. è¿™æ¬¡æ‰€æœ‰ CI æ£€æŸ¥éƒ½ä¼šé€šè¿‡ âœ…
```

---

## ğŸ¯ æ¼”ç¤º 3: CI æˆåŠŸï¼Œè§¦å‘å®Œæ•´ CD

### æ­¥éª¤ 1: åˆå¹¶åˆ° main åˆ†æ”¯

```bash
# å‰æï¼šPR çš„æ‰€æœ‰ CI æ£€æŸ¥å·²é€šè¿‡

# æ–¹å¼ 1: åœ¨ GitHub ä¸Šç‚¹å‡» "Merge pull request"

# æ–¹å¼ 2: å‘½ä»¤è¡Œåˆå¹¶
git checkout main
git merge demo/ci-failure
git push origin main
```

### æ­¥éª¤ 2: è§‚å¯Ÿå®Œæ•´ CI/CD æµç¨‹

æ¨é€åˆ° main åï¼Œworkflow ä¼šæ‰§è¡Œå®Œæ•´æµç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CI é˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ä»£ç è´¨é‡æ£€æŸ¥                         â”‚
â”‚ âœ… æ„å»ºå’Œæµ‹è¯•                          â”‚
â”‚ âœ… é›†æˆæµ‹è¯•                            â”‚
â”‚ âœ… CI æ€»ç»“                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
          CI æˆåŠŸï¼ç»§ç»­...
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CD é˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ³ æ„å»º Docker é•œåƒ                    â”‚
â”‚    â””â”€ âœ… Backend é•œåƒæ„å»ºå®Œæˆ           â”‚
â”‚    â””â”€ âœ… Frontend é•œåƒæ„å»ºå®Œæˆ          â”‚
â”‚                                       â”‚
â”‚ ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ                       â”‚
â”‚    â””â”€ âœ… staging.voyagemate.com       â”‚
â”‚                                       â”‚
â”‚ ğŸ’¨ å†’çƒŸæµ‹è¯•                            â”‚
â”‚    â””â”€ âœ… å¥åº·æ£€æŸ¥é€šè¿‡                   â”‚
â”‚                                       â”‚
â”‚ ğŸ‘¤ ç­‰å¾…äººå·¥å®¡æ‰¹                         â”‚
â”‚    â””â”€ â¸ï¸  éœ€è¦ç®¡ç†å‘˜æ‰¹å‡†               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 3: æ‰¹å‡†ç”Ÿäº§éƒ¨ç½²

1. è¿›å…¥ GitHub Actions é¡µé¢
2. æ‰¾åˆ°æ­£åœ¨è¿è¡Œçš„ workflow
3. åœ¨ "ç­‰å¾…äººå·¥å®¡æ‰¹" æ­¥éª¤
4. ç‚¹å‡» "Review deployments"
5. é€‰æ‹© "production-approval"
6. ç‚¹å‡» "Approve and deploy"

### æ­¥éª¤ 4: è§‚å¯Ÿç”Ÿäº§éƒ¨ç½²

æ‰¹å‡†åç»§ç»­ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ                     â”‚
â”‚    â””â”€ âœ… æ»šåŠ¨æ›´æ–°å®Œæˆ                 â”‚
â”‚                                     â”‚
â”‚ âœ… éƒ¨ç½²åéªŒè¯                         â”‚
â”‚    â””â”€ âœ… å¥åº·æ£€æŸ¥é€šè¿‡                 â”‚
â”‚    â””â”€ âœ… ç›‘æ§æŒ‡æ ‡æ­£å¸¸                 â”‚
â”‚                                     â”‚
â”‚ ğŸ‰ æµç¨‹å®Œæˆ                          â”‚
â”‚    â””â”€ âœ… CI/CD å…¨éƒ¨æˆåŠŸ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å¯¹æ¯”ï¼šPR vs Push to Main

### Pull Request (åªæ‰§è¡Œ CI)

```
äº‹ä»¶: åˆ›å»º PR
è§¦å‘å™¨: pull_request
åˆ†æ”¯: feature â†’ main

æ‰§è¡Œé˜¶æ®µ:
â”œâ”€ âœ… CI é˜¶æ®µï¼ˆå…¨éƒ¨ï¼‰
â”‚  â”œâ”€ ä»£ç æ£€æŸ¥
â”‚  â”œâ”€ æ„å»ºæµ‹è¯•
â”‚  â”œâ”€ é›†æˆæµ‹è¯•
â”‚  â””â”€ CI æ€»ç»“
â”‚
â””â”€ â¹ï¸ CD é˜¶æ®µï¼ˆè·³è¿‡ï¼‰
   åŸå› : if: github.event_name == 'push' AND github.ref == 'refs/heads/main'
   ç»“æœ: CD ä¸æ‰§è¡Œ
```

### Push to Main (æ‰§è¡Œå®Œæ•´ CI/CD)

```
äº‹ä»¶: æ¨é€åˆ° main
è§¦å‘å™¨: push
åˆ†æ”¯: main

æ‰§è¡Œé˜¶æ®µ:
â”œâ”€ âœ… CI é˜¶æ®µï¼ˆå…¨éƒ¨ï¼‰
â”‚  â”œâ”€ ä»£ç æ£€æŸ¥
â”‚  â”œâ”€ æ„å»ºæµ‹è¯•
â”‚  â”œâ”€ é›†æˆæµ‹è¯•
â”‚  â””â”€ CI æ€»ç»“
â”‚
â””â”€ âœ… CD é˜¶æ®µï¼ˆå…¨éƒ¨ï¼‰
   â”œâ”€ æ„å»ºé•œåƒ
   â”œâ”€ éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ
   â”œâ”€ å†’çƒŸæµ‹è¯•
   â”œâ”€ ç­‰å¾…å®¡æ‰¹ â¸ï¸
   â”œâ”€ éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
   â””â”€ éƒ¨ç½²éªŒè¯
```

---

## ğŸ” å¦‚ä½•æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### åœ¨ GitHub ä¸ŠæŸ¥çœ‹

1. è¿›å…¥ä»“åº“é¡µé¢
2. ç‚¹å‡» "Actions" æ ‡ç­¾
3. é€‰æ‹©å…·ä½“çš„ workflow run
4. ç‚¹å‡»ä»»ä¸€ job æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### å…³é”®æ—¥å¿—ç¤ºä¾‹

**CI æˆåŠŸæ—¥å¿—**ï¼š
```bash
ğŸ“Š CI é˜¶æ®µæ€»ç»“æŠ¥å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ä»£ç æ£€æŸ¥: success
âœ… æ„å»ºæµ‹è¯•: success
âœ… é›†æˆæµ‹è¯•: success
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¨ CI å…¨éƒ¨é€šè¿‡ï¼
```

**CI å¤±è´¥æ—¥å¿—**ï¼š
```bash
ğŸ“Š æ£€æŸ¥ CI å„é˜¶æ®µçŠ¶æ€...
ä»£ç æ£€æŸ¥: success
æ„å»ºæµ‹è¯•: failure
é›†æˆæµ‹è¯•: skipped

âŒ CI å¤±è´¥ï¼æµç¨‹ç»ˆæ­¢ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤
Error: Process completed with exit code 1.
```

---

## âœ… éªŒè¯é€€å›æœºåˆ¶

### ç¡®è®¤ CD ä¸ä¼šåœ¨ CI å¤±è´¥æ—¶æ‰§è¡Œ

åœ¨ workflow æ—¥å¿—ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
ci-summary
  âŒ The job failed

build-docker
  â¹ï¸ This job was skipped
  Reason: Dependency job 'ci-summary' failed

deploy-staging
  â¹ï¸ This job was skipped
  Reason: Dependency job 'ci-summary' failed

... (æ‰€æœ‰ CD é˜¶æ®µéƒ½è¢«è·³è¿‡)
```

è¿™è¯æ˜äº†ï¼š
- âœ… CI å¤±è´¥è¢«æ­£ç¡®æ£€æµ‹
- âœ… CD é˜¶æ®µè¢«æ­£ç¡®é˜»æ­¢
- âœ… é€€å›æœºåˆ¶å·¥ä½œæ­£å¸¸

---

## ğŸ“ å…³é”®æ¦‚å¿µæ€»ç»“

### 1. ä¾èµ–é“¾ (needs)

```yaml
job-b:
  needs: job-a  # job-a å¿…é¡»æˆåŠŸï¼Œjob-b æ‰ä¼šæ‰§è¡Œ
```

### 2. æ¡ä»¶æ‰§è¡Œ (if)

```yaml
job:
  if: github.ref == 'refs/heads/main'  # åªåœ¨ main åˆ†æ”¯æ‰§è¡Œ
```

### 3. å¤±è´¥å¤„ç†

```yaml
steps:
  - run: |
      if [[ "${{ needs.previous.result }}" == "failure" ]]; then
        echo "âŒ ä¸Šä¸€æ­¥å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
        exit 1  # è¿™ä¼šæ ‡è®°å½“å‰ job ä¸ºå¤±è´¥
      fi
```

### 4. å§‹ç»ˆæ‰§è¡Œ (always)

```yaml
job:
  if: always()  # å³ä½¿ä¾èµ–å¤±è´¥ä¹Ÿæ‰§è¡Œï¼ˆç”¨äºæ€»ç»“ï¼‰
```

---

## ğŸš€ ç°åœ¨å°±è¯•è¯•ï¼

```bash
# 1. æ¨é€æ¼”ç¤ºåˆ†æ”¯
cd /root/voyagemate/new-voyage-mate
git push origin demo/ci-failure

# 2. åœ¨ GitHub åˆ›å»º PR

# 3. è§‚å¯Ÿ CI æµç¨‹

# 4. åˆå¹¶åè§‚å¯Ÿå®Œæ•´ CI/CD æµç¨‹
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### å½“å‰çš„æ¼”ç¤º workflow æ˜¯**æ¨¡æ‹Ÿ**çš„

å®é™…çš„éƒ¨ç½²æ­¥éª¤ï¼ˆé˜¶æ®µ 6-10ï¼‰ä½¿ç”¨çš„æ˜¯ `echo` å‘½ä»¤æ¨¡æ‹Ÿã€‚

è¦å®ç°çœŸå®éƒ¨ç½²ï¼Œéœ€è¦ï¼š

1. **æ·»åŠ  Dockerfile**:
   ```dockerfile
   # backend/Dockerfile
   FROM openjdk:17-jdk-slim
   COPY target/*.jar app.jar
   EXPOSE 8080
   ENTRYPOINT ["java", "-jar", "/app.jar"]
   ```

2. **é…ç½® GitHub Secrets**:
   - `SSH_PRIVATE_KEY`
   - `SERVER_HOST`
   - `DOCKER_USERNAME`
   - `DOCKER_PASSWORD`

3. **å‡†å¤‡æœåŠ¡å™¨**:
   - æµ‹è¯•ç¯å¢ƒæœåŠ¡å™¨
   - ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨
   - å®‰è£… Docker

4. **æ›¿æ¢ echo ä¸ºå®é™…å‘½ä»¤**:
   ```yaml
   # å°†
   - run: echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
   
   # æ”¹ä¸º
   - run: |
       ssh user@${{ secrets.SERVER_HOST }} "
         docker pull myapp:latest
         docker-compose up -d
       "
   ```

ä½†**æ ¸å¿ƒçš„ CI å¤±è´¥é€€å›æœºåˆ¶å·²ç»å®Œå…¨å¯ç”¨**ï¼

---

## âœ¨ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰çš„èƒ½åŠ›ï¼š

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| PR è§¦å‘ CI | âœ… å¯ç”¨ | æäº¤ PR è‡ªåŠ¨è¿è¡Œæ£€æŸ¥ |
| CI å¤±è´¥é€€å› | âœ… å¯ç”¨ | æ£€æµ‹å¤±è´¥å¹¶é˜»æ­¢åç»­æ­¥éª¤ |
| CI æˆåŠŸç»§ç»­ | âœ… å¯ç”¨ | CI é€šè¿‡åæ‰§è¡Œ CD |
| åˆ†æ”¯ä¿æŠ¤ | âœ… å¯ç”¨ | åªåœ¨ main åˆ†æ”¯éƒ¨ç½² |
| äººå·¥å®¡æ‰¹ | âœ… å¯ç”¨ | ç”Ÿäº§éƒ¨ç½²éœ€è¦æ‰¹å‡† |
| å®é™…éƒ¨ç½² | âš ï¸ éœ€é…ç½® | éœ€è¦æœåŠ¡å™¨å’Œå‡­è¯ |

ğŸ‰ **å¯ä»¥å¼€å§‹æ¼”ç¤ºäº†ï¼**

